worker_processes 1;

# 必須の events セクション
events {
    worker_connections 1024;
}

http {
    lua_shared_dict redis_cache 10m;

    server {
        listen 80;

        location / {
            # 事前に$target変数を定義
            set $target "";

            # Luaスクリプトで振り分け先を取得してプロキシ設定
            access_by_lua_block {
                local redis = require "resty.redis"
                local red = redis:new()

                -- Redis接続設定
                red:set_timeout(1000)  -- タイムアウト設定 (ms)
                local ok, err = red:connect("127.0.0.1", 6379)
                if not ok then
                    ngx.log(ngx.ERR, "failed to connect to Redis: ", err)
                    return ngx.exit(ngx.HTTP_SERVICE_UNAVAILABLE)
                end

                -- ヘッダからMIDを取得
                local mid = ngx.req.get_headers()["ID"]
                if not mid then
                    ngx.log(ngx.ERR, "MID header is missing")
                    return ngx.exit(ngx.HTTP_BAD_REQUEST)
                end

                -- RedisでMIDに対応する振り分け先を取得
                local target, err = red:get(mid)
                if not target or target == ngx.null then
                    ngx.log(ngx.ERR, "Target not found for MID: ", mid)
                    return ngx.exit(ngx.HTTP_NOT_FOUND)
                end

                -- 振り分け先の設定
                ngx.var.target = target

                -- Redis接続を閉じる
                local ok, err = red:set_keepalive(10000, 100)
                if not ok then
                    ngx.log(ngx.ERR, "failed to set keepalive: ", err)
                end
            }

            # 振り分け先を動的に設定するプロキシ
            proxy_pass http://$target;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
